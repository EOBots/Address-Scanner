import frida
import time

PROCESS = "Endless.exe"
WALK_RVA = 0xEEC70  # from your script

session = frida.attach(PROCESS)

js_code = """
var mod = Process.getModuleByName("Endless.exe");
var base = mod.base;
var walkFuncPtr = base.add(%d);   // EO movement function

var playerPtr = null;

// Hook movement to capture player struct pointer
Interceptor.attach(walkFuncPtr, {
    onEnter: function(args) {
        var reg = this.context.ecx || this.context.rcx;
        if (reg && !playerPtr) {
            playerPtr = reg;
            send({"player": playerPtr.toString()});
        }
    }
});

// Create callable movement function
var walkFunc = new NativeFunction(walkFuncPtr, 'void', ['int']);

rpc.exports = {
    move: function(dir) {
        if (playerPtr === null)
            return -1; // not ready
        walkFunc(dir);
        return 1;
    },
    isready: function() {
        return playerPtr !== null;
    }
};
""" % WALK_RVA

script = session.create_script(js_code)

def on_msg(message, data):
    if message["type"] == "send":
        print("[JS]", message["payload"])
    else:
        print("[ERR]", message)

script.on("message", on_msg)
script.load()

print("Move once in EO to capture player pointer...")

# Wait for pointer
while script.exports.isready() == False:
    time.sleep(0.1)

print("Ready!")

# Test movement:
print("Moving UP...")
script.exports.move(0)
time.sleep(1)

print("Moving RIGHT...")
script.exports.move(1)
time.sleep(1)

print("Moving DOWN...")
script.exports.move(2)
time.sleep(1)

print("Moving LEFT...")
script.exports.move(3)
time.sleep(1)

print("Done.")
