import frida
import time

PROCESS_NAME = "Endless.exe"
DIRECTIONAL_RVA = 0x6DACA   # Verified from CeraBot v12.2


def on_message(message, data):
    if message["type"] == "send":
        print("[✓]", message["payload"])
    elif message["type"] == "error":
        print("[Error]", message)


def main():
    print("=== EO Direction Byte Scanner (Frida 16) ===")
    print("Attach → Press ANY movement key → Script prints the directional address.")
    print("\nMake sure Endless.exe is running and your character is in-game.")
    input("Press Enter to attach...\n")

    session = frida.attach(PROCESS_NAME)

    js = f"""
    var base = Process.getModuleByName("{PROCESS_NAME}").base;
    var inst = base.add({DIRECTIONAL_RVA});   // mov [ebx+55], dl

    Interceptor.attach(inst, {{
      onEnter: function(args) {{
        var ebx = this.context.ebx || this.context.rbx;
        if (!ebx) {{
          send("No EBX/RBX — unexpected.");
          return;
        }}

        var directionalAddress = ebx.add(0x55);   // ALWAYS the direction byte
        var value = directionalAddress.readU8();

        send("directional_address = " 
            + directionalAddress.toString() 
            + "   value=" + value);

      }}
    }});
    """

    script = session.create_script(js)
    script.on("message", on_message)
    script.load()

    print("Scanner armed. Now ALT-TAB to EO and press ANY direction (W/A/S/D or arrow keys).")
    print("The moment you move, your real directional address will appear above.\n")

    # keep the script alive
    while True:
        time.sleep(0.2)


if __name__ == "__main__":
    main()
